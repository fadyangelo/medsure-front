---
import { STRAPI_URL } from 'astro:env/server';
import MyFooter from '../components/MyFooter.astro';

// We only use the server variable here to pass it to the client if needed, 
// but we will stick to the specific URL provided in your request.
const medicalNetwork_APIPath = `${STRAPI_URL}/api/medical-network`;
---

<!DOCTYPE html>
<html lang="en" class="page-medical-network">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedSure - Medical Insurance Services</title>
    <meta name="description" content="Comprehensive medical insurance solutions designed to protect you and your family.">
    
    <!-- CSS Dependencies -->
    <link rel="stylesheet" href="/fonts/cairo/stylesheet.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/contact.css">
    <link rel="stylesheet" href="/css/services.css">
    <link rel="stylesheet" href="/css/counter.css">
    <link rel="stylesheet" href="/css/medical-network.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <!-- Leaflet Marker Cluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        /* Map Loader Overlay */
        .map-wrapper { position: relative; }
        .map-loader {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.85);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }
        .map-loader.active { display: flex; }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #2563eb;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="header" id="headermain">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <img src="/images/logo_icon.png" alt="MedSure Logo" class="logo-img">
                    </div>
                </div>

                <nav class="nav-desktop">
                    <a href="/" data-i18n="nav.home">Home</a> | 
                    <a href="/services" data-i18n="nav.services">Services</a>  | 
                    <a href="/beneficiaries" data-i18n="nav.beneficiaries">Beneficiaries</a>  | 
                    <a href="/medical-network" class="active" data-i18n="nav.medical_network">Medical network</a>  | 
                    <a href="/about" data-i18n="nav.about">About Us</a>  | 
                    <a href="/contact" data-i18n="nav.contact">Contact us</a>
                </nav>

                <div class="header-buttons">
                    <a href="/medical-network" data-i18n="nav.find_provider" class="btn btn-medical">Find a Provider</a>
                </div>

                <!-- Language Selector -->
                <div class="lang-selector">
                    <button class="lang-button" type="button" aria-haspopup="true" aria-expanded="false" onclick="toggleLangMenu(event)">
                        <span class="current-lang-label">EN</span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="m6 9 6 6 6-6"/>
                        </svg>
                    </button>
                    <div class="lang-menu hidden" role="menu">
                        <button class="lang-option" role="menuitemradio" aria-checked="true" data-lang="en" onclick="setLanguage('en')">
                            <span class="check">✓</span>
                            <span>English</span>
                        </button>
                        <button class="lang-option" role="menuitemradio" aria-checked="false" data-lang="ar" onclick="setLanguage('ar')">
                            <span class="check">✓</span>
                            <span>العربية</span>
                        </button>
                    </div>
                </div>

                <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                    <svg class="menu-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="4" x2="20" y1="6" y2="6"/>
                        <line x1="4" x2="20" y1="12" y2="12"/>
                        <line x1="4" x2="20" y1="18" y2="18"/>
                    </svg>
                    <svg class="close-icon hidden" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="m18 6-12 12"/>
                        <path d="m6 6 12 12"/>
                    </svg>
                </button>
            </div>

            <div class="mobile-menu hidden">
                <nav class="mobile-nav">
                    <a href="/" data-i18n="nav.home">Home</a>
                    <a href="/services" data-i18n="nav.services">Services</a>
                    <a href="/beneficiaries" data-i18n="nav.beneficiaries">Beneficiaries</a> 
                    <a href="/medical-network" class="active" data-i18n="nav.medical_network">Medical network</a> 
                    <a href="/about" data-i18n="nav.about">About Us</a> 
                    <a href="/contact" data-i18n="nav.contact">Contact us</a>

                    <div class="mobile-buttons">
                        <a href="/medical-network" data-i18n="nav.find_provider" class="btn btn-medical">Find a Provider</a>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <main class="main-content">
        <!-- Hero Section -->
        <section class="network-hero">
            <div class="container">
                <h1>Find a Healthcare Provider</h1>
                <p>Search our network of trusted healthcare providers across Egypt</p>
            </div>
        </section>

        <!-- Search Section -->
        <section class="search-section">
            <div class="search-container">
                <form id="provider-search-form">
                    <div class="search-filters">
                        <div class="filter-group">
                            <label for="city">City</label>
                            <select id="city" class="filter-select">
                                <option value="">All Cities</option>
                                <option value="القاهرة">القاهرة</option>
                                <option value="الجيزة">الجيزة</option>
                                <option value="الاسكندرية">الاسكندرية</option>
                                <option value="الاسماعيلية">الاسماعيلية</option>
                                <option value="الاقصر">الاقصر</option>
                                <option value="البحر الاحمر">البحر الاحمر</option>
                                <option value="البحيرة">البحيرة</option>
                                <option value="الدقهلية">الدقهلية</option>
                                <option value="السويس">السويس</option>
                                <option value="الشرقية">الشرقية</option>
                                <option value="الغربية">الغربية</option>
                                <option value="الفيوم">الفيوم</option>
                                <option value="القليوبية">القليوبية</option>
                                <option value="المنوفية">المنوفية</option>
                                <option value="المنيا">المنيا</option>
                                <option value="الوادي الجديد">الوادي الجديد</option>
                                <option value="أسوان">أسوان</option>
                                <option value="أسيوط">أسيوط</option>
                                <option value="بني سويف">بني سويف</option>
                                <option value="بورسعيد">بورسعيد</option>
                                <option value="جنوب سيناء">جنوب سيناء</option>
                                <option value="دمياط">دمياط</option>
                                <option value="سوهاج">سوهاج</option>
                                <option value="شمال سيناء">شمال سيناء</option>
                                <option value="قنا">قنا</option>
                                <option value="كفر الشيخ">كفر الشيخ</option>
                                <option value="مرسى مطروح">مرسى مطروح</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="specialty">Specialty</label>
                            <select id="specialty" class="filter-select">
                                <option value="">All Specialties</option>
                                <option value="للقلب و الاوعية الدموية">للقلب و الاوعية الدموية</option>
                                <option value="MRI - CT - Xray - Sonar">MRI - CT - Xray - Sonar</option>
                                <option value="اخصائى الجراحة العامة والاورام والمناظير">اخصائى الجراحة العامة والاورام والمناظير</option>
                                <option value="اخصائى الجهاز الهضمى والكبد">اخصائى الجهاز الهضمى والكبد</option>
                                <option value="اخصائى امراض النساء والتوليد">اخصائى امراض النساء والتوليد</option>
                                <option value="اخصائى باطنة">اخصائى باطنة</option>
                                <option value="اخصائى باطنه">اخصائى باطنه</option>
                                <option value="اخصائى جراحة العظام">اخصائى جراحة العظام</option>
                                <option value="اخصائى جراحة العيون">اخصائى جراحة العيون</option>
                                <option value="اخصائى جراحة عامة وجراحة المناظير">اخصائى جراحة عامة وجراحة المناظير</option>
                                <option value="اخصائى جراحة عظام">اخصائى جراحة عظام</option>
                                <option value="اخصائى جلدية وتناسلية">اخصائى جلدية وتناسلية</option>
                                <option value="اخصائى صدر">اخصائى صدر</option>
                                <option value="اشعة">اشعة</option>
                                <option value="اطفال">اطفال</option>
                                <option value="التحاليل الطبية">التحاليل الطبية</option>
                                <option value="العيون والليزك">العيون والليزك</option>
                                <option value="القلب و القسطرة">القلب و القسطرة</option>
                                <option value="الكلى والمسالك">الكلى والمسالك</option>
                                <option value="النساء والتوليد وعلاج العقم">النساء والتوليد وعلاج العقم</option>
                                <option value="امراض القلب">امراض القلب</option>
                                <option value="امراض باطنة">امراض باطنة</option>
                                <option value="انف و اذن و حنجرة">انف و اذن و حنجرة</option>
                                <option value="اورام">اورام</option>
                                <option value="باطنة">باطنة</option>
                                <option value="تحاليل">تحاليل</option>
                                <option value="جراحة عامة">جراحة عامة</option>
                                <option value="جراحة عظام">جراحة عظام</option>
                                <option value="جراحة عيون">جراحة عيون</option>
                                <option value="جلديه وتناسليه">جلديه وتناسليه</option>
                                <option value="علاج طبيعى">علاج طبيعى</option>
                                <option value="عيون">عيون</option>
                                <option value="قلب">قلب</option>
                                <option value="مخ واعصاب">مخ واعصاب</option>
                                <option value="مسالك بولية">مسالك بولية</option>
                                <option value="نساء و توليد">نساء و توليد</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label for="network">Network</label>
                            <select id="network" class="filter-select">
                                <option value="">All Tiers</option>
                                <option value="A++">A++</option>
                                <option value="A+">A+</option>
                                <option value="A">A</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="provider">Provider name</label>
                            <input type="text" id="provider" class="filter-select" placeholder="Search by name">
                        </div>
                    </div>
                    
                    <button type="submit" class="search-btn">
                        <i class="fas fa-search"></i> Search Providers
                    </button>
                </form>
            </div>
        </section>

        <!-- Map Section -->
        <section class="map-section">
            <div class="container">
                <div class="map-wrapper">
                    <!-- Loader -->
                    <div id="loader" class="map-loader">
                        <div class="spinner"></div>
                        <p style="color:#2563eb; font-weight:600;">Updating Map...</p>
                    </div>
                    
                    <!-- Map Container -->
                    <div id="provider-map" style="height: 420px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08);"></div>
                </div>
                <!-- Result Count Display -->
                <div id="results-count" style="text-align:center; padding-top:10px; color:#666; font-weight:bold;"></div>
            </div>
        </section>

        <!-- Stats Section -->
        <section class="stats-section">
            <div class="stats-container">
                <div class="section-header">
                    <h2>Our Network at a Glance</h2>
                    <p>Trusted by thousands across Egypt</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="provider-count-stat">4,500+</div>
                        <div class="stat-label">Providers Nationwide</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-number">27</div>
                        <div class="stat-label">Governorates Covered</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-number">98%</div>
                        <div class="stat-label">Approval Rate</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-number">24/7</div>
                        <div class="stat-label">Medical Support</div>
                    </div>
                </div>
                
                <div class="features-grid">
                    <div class="feature-card">
                        <h3><i class="fas fa-network-wired"></i> Comprehensive Network</h3>
                        <ul>
                            <li>Weekly updated directory</li>
                            <li>Full specialty coverage</li>
                            <li>Graded network (A++, A+, A)</li>
                        </ul>
                    </div>
                    
                    <div class="feature-card">
                        <h3><i class="fas fa-headset"></i> Real Medical Support</h3>
                        <p>Our call center is staffed by trained medical professionals, ready to assist with approvals, questions, or emergencies anytime.</p>
                    </div>
                    
                    <div class="feature-card">
                        <h3><i class="fas fa-bolt"></i> Fast Approvals & Claims</h3>
                        <ul>
                            <li>98% of outpatient approvals in under 10 minutes</li>
                            <li>Reimbursements processed within 5–14 working days</li>
                        </ul>
                    </div>
                    
                    <div class="feature-card">
                        <h3><i class="fas fa-building"></i> Employer Solutions</h3>
                        <p>We support both insured and self-funded models, with real-time dashboards, cost tracking, and custom reporting tools.</p>
                    </div>
                    
                    <div class="feature-card">
                        <h3><i class="fas fa-id-card"></i> Smart Medical Cards</h3>
                        <p>Whether it's a cash, prepaid, or insurance card — members get access to discounted rates, fast approvals, and a smooth experience every time.</p>
                    </div>
                    
                    <div class="feature-card">
                        <h3><i class="fas fa-hands-helping"></i> On-the-Ground Support</h3>
                        <p>We offer roving doctors, doctor-on-site (DOS) visits, and in-house network communication to resolve issues on the spot.</p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Provider Form Section -->
        <section class="provider-form-section">
            <div class="provider-form-container">
                <div class="provider-form">
                    <div class="form-title">
                        <h2>Want to join our network?</h2>
                        <p>Fill out the form below to become a MedSure healthcare provider</p>
                    </div>
                    
                    <form id="provider-application-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="facility-name">Facility Name *</label>
                                <input type="text" id="facility-name" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="facility-type">Facility Type *</label>
                                <select id="facility-type" class="form-control" required>
                                    <option value="">Select Facility Type</option>
                                    <option value="hospital">Hospital</option>
                                    <option value="clinic">Clinic</option>
                                    <option value="pharmacy">Pharmacy</option>
                                    <option value="lab">Laboratory</option>
                                    <option value="radiology">Radiology Center</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="contact-person">Contact Person *</label>
                                <input type="text" id="contact-person" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="phone">Phone Number *</label>
                                <input type="tel" id="phone" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="email">Email Address *</label>
                                <input type="email" id="email" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="location">Location (City/Governorate) *</label>
                                <input type="text" id="location" class="form-control" required>
                            </div>
                            
                            <div class="form-group full-width">
                                <label for="address">Full Address *</label>
                                <input type="text" id="address" class="form-control" required>
                            </div>
                            
                            <div class="form-group full-width">
                                <label for="services">Services Provided *</label>
                                <textarea id="services" class="form-control" required></textarea>
                            </div>
                            
                            <div class="form-group full-width">
                                <label for="message">Additional Information</label>
                                <textarea id="message" class="form-control" placeholder="Tell us about your facility and why you'd like to join our network"></textarea>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn-submit">
                            <i class="fas fa-paper-plane"></i> Submit Application
                        </button>
                    </form>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <MyFooter />

    <!-- Scripts -->
    <script is:inline src="/js/main.js"></script>
    <!-- Leaflet JS -->
    <script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <!-- Leaflet Marker Cluster JS -->
    <script is:inline src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <!-- MAIN MAP LOGIC -->
    <script is:inline>
        // --- 1. Map Initialization (Performance Optimized) ---
        // preferCanvas: true tells Leaflet to draw markers on a canvas rather than creating DOM nodes
        const map = L.map('provider-map', { preferCanvas: true }).setView([26.8206, 30.8025], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; MedSure'
        }).addTo(map);

        // --- 2. Marker Clustering Initialization ---
        // chunkedLoading: true prevents browser freeze with 5000+ points
        const markers = L.markerClusterGroup({
            chunkedLoading: true, 
            chunkInterval: 200, 
            disableClusteringAtZoom: 16,
            spiderfyOnMaxZoom: true,
        });
        map.addLayer(markers);

        // Custom Icon
        const customIcon = L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
            iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        // --- 3. Data Fetching ---
        const API_URL = "https://medsure1.itspark-eg.com/api/medical-networks";
        const loader = document.getElementById('loader');
        const resultsCountDiv = document.getElementById('results-count');
        const statNumberDiv = document.getElementById('provider-count-stat');

        async function fetchProviders() {
            // Show Loader
            if(loader) loader.classList.add('active');

            // Get Input Values safely
            const city = document.getElementById('city')?.value || '';
            const specialty = document.getElementById('specialty')?.value || '';
            const network = document.getElementById('network')?.value || '';
            const name = document.getElementById('provider')?.value || '';

            // Build Strapi Params
            const params = new URLSearchParams();
            
            // Optimization: Fetch large batch but only necessary fields
            params.append('pagination[pageSize]', '2500'); 
            params.append('fields[0]', 'ProviderName');
            params.append('fields[1]', 'Latitude');
            params.append('fields[2]', 'Longitude');
            params.append('fields[3]', 'City');
            params.append('fields[4]', 'Specialty');
            params.append('fields[5]', 'NetworkType');
            params.append('fields[6]', 'ProviderType');
            params.append('fields[7]', 'Address');

            // Apply Filters
            if (city) params.append('filters[City][$eq]', city);
            if (specialty) params.append('filters[Specialty][$eq]', specialty);
            if (network) params.append('filters[NetworkType][$eq]', network);
            if (name) params.append('filters[ProviderName][$contains]', name);

            try {
                const response = await fetch(`${API_URL}?${params.toString()}`);
                if (!response.ok) throw new Error("Failed to fetch data");
                
                const json = await response.json();
                updateMap(json.data);
                
            } catch (error) {
                console.error("Map Error:", error);
                if(resultsCountDiv) resultsCountDiv.innerHTML = "Error loading providers.";
            } finally {
                if(loader) loader.classList.remove('active');
            }
        }

        // --- 4. Update Map Logic ---
        function updateMap(data) {
            markers.clearLayers(); // Clear old clusters

            if (!data || data.length === 0) {
                if(resultsCountDiv) resultsCountDiv.innerHTML = "No providers found.";
                return;
            }

            const newMarkers = [];

            data.forEach(item => {
                // Parse coordinates safely
                const lat = parseFloat(item.Latitude);
                const lng = parseFloat(item.Longitude);

                if (!isNaN(lat) && !isNaN(lng)) {
                    const m = L.marker([lat, lng], { icon: customIcon });
                    
                    const popupHtml = `
                        <div style="min-width:200px; font-family:'Cairo',sans-serif;">
                            <h4 style="color:#2563eb; margin:0 0 5px 0;">${item.ProviderName}</h4>
                            <div style="font-size:13px; color:#555;">
                                <strong>Type:</strong> ${item.ProviderType || '-'}<br>
                                <strong>City:</strong> ${item.City || '-'}<br>
                                <strong>Specialty:</strong> ${item.Specialty || '-'}<br>
                                <strong>Network:</strong> <span style="background:#eee; padding:2px 4px; border-radius:3px; font-weight:bold;">${item.NetworkType || 'A'}</span>
                                ${item.Address ? `<hr style="margin:5px 0; border:0; border-top:1px solid #ddd;">${item.Address}` : ''}
                            </div>
                        </div>
                    `;
                    m.bindPopup(popupHtml);
                    newMarkers.push(m);
                }
            });

            // Add markers to cluster
            markers.addLayers(newMarkers);

            // Update UI Counters
            if(resultsCountDiv) resultsCountDiv.innerHTML = `Found ${newMarkers.length} Providers`;
            if(statNumberDiv) statNumberDiv.innerHTML = newMarkers.length;

            // Fit map to show all results
            if (newMarkers.length > 0) {
                map.fitBounds(markers.getBounds(), { padding: [50, 50] });
            }
        }

        // --- 5. Event Listeners (Triggers) ---
        
        // Initial Load
        fetchProviders();

        // Search Button
        document.getElementById('provider-search-form')?.addEventListener('submit', (e) => {
            e.preventDefault();
            fetchProviders();
        });

        // Dropdown Changes (City, Specialty, Network)
        ['city', 'specialty', 'network'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('change', fetchProviders);
        });

        // Name Search Debounce (Wait 500ms after typing)
        let timer;
        const nameInput = document.getElementById('provider');
        if (nameInput) {
            nameInput.addEventListener('input', () => {
                clearTimeout(timer);
                timer = setTimeout(fetchProviders, 500);
            });
        }
    </script>
	<script is:inline src="/js/translations.js"></script>
	<script is:inline src="/js/counter.js"></script>
</body>
</html>