---
// src/pages/medical-network.astro
import { STRAPI_URL } from 'astro:env/server';

// Server Side Fetch for Dropdown Options (City/Specialty)
// We fetch unique values to populate the <select> boxes
let cities: string[] = [];
let specialties: string[] = [];

try {
  // Fetch a small batch just to extract categories, or use a specific collection-type for categories if you have one
  const response = await fetch("https://medsure1.itspark-eg.com/api/medical-networks?fields[0]=City&fields[1]=Speciality&pagination[pageSize]=100");
  const data = await response.json();
  
  if(data.data){
    const allCities = data.data.map((i:any) => i.attributes.City).filter(Boolean);
    const allSpecs = data.data.map((i:any) => i.attributes.Speciality).filter(Boolean);
    
    cities = [...new Set(allCities)] as string[]; // Unique cities
    specialties = [...new Set(allSpecs)] as string[]; // Unique specialties
  }
} catch (e) {
  console.error("Error fetching filter options", e);
}
---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedSure Network Map</title>
    <link rel="stylesheet" href="/css/styles.css">
    
    <!-- 1. Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- 2. MarkerCluster CSS (Crucial for "100 pin" limit visual) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <style>
        /* Map Container */
        #provider-map {
            height: 600px; /* Taller map for better view */
            width: 100%;
            border-radius: 12px;
            z-index: 1;
        }
        
        /* Loading Overlay */
        .map-wrapper { position: relative; }
        .map-loader {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            z-index: 1000;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #2563eb;
        }
        .map-loader.active { display: flex; }
    </style>
</head>
<body>
    
    <!-- Header/Nav would go here -->

    <main class="main-content">
        <section class="search-section" style="padding: 40px 0; background: #f8f9fa;">
            <div class="container">
                <form id="filter-form" class="search-filters" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                    
                    <!-- City Select -->
                    <div class="filter-group">
                        <label>City</label>
                        <select id="city" name="city" class="filter-select">
                            <option value="">All Cities</option>
                            {cities.map(city => <option value={city}>{city}</option>)}
                        </select>
                    </div>

                    <!-- Specialty Select -->
                    <div class="filter-group">
                        <label>Specialty</label>
                        <select id="specialty" name="specialty" class="filter-select">
                            <option value="">All Specialties</option>
                            {specialties.map(spec => <option value={spec}>{spec}</option>)}
                        </select>
                    </div>

                    <!-- Network Select (Static usually) -->
                    <div class="filter-group">
                        <label>Network Type</label>
                        <select id="network" name="network" class="filter-select">
                            <option value="">All Networks</option>
                            <option value="A++">A++</option>
                            <option value="A+">A+</option>
                            <option value="A">A</option>
                        </select>
                    </div>

                    <!-- Provider Name -->
                    <div class="filter-group">
                        <label>Provider Name</label>
                        <input type="text" id="providerName" name="name" placeholder="Hospital Name..." class="filter-select">
                    </div>

                    <button type="submit" class="btn-medical" style="background: #2563eb; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer;">
                        Search Map
                    </button>
                </form>
            </div>
        </section>

        <section class="map-section">
            <div class="container">
                <div class="map-wrapper">
                    <div id="loader" class="map-loader">Searching Network...</div>
                    <div id="provider-map"></div>
                </div>
                <p id="result-count" style="text-align: center; margin-top: 10px; color: #666;"></p>
            </div>
        </section>
    </main>

    <!-- Scripts -->
    <!-- 1. Leaflet JS -->
    <script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- 2. MarkerCluster JS -->
    <script is:inline src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script is:inline>
        // --- Configuration ---
        const map = L.map('provider-map').setView([30.0444, 31.2357], 7); // Default Center (Cairo)
        const loader = document.getElementById('loader');
        const countDisplay = document.getElementById('result-count');

        // Add Tile Layer (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '&copy; MedSure'
        }).addTo(map);

        // --- Marker Clustering Setup ---
        // This is the key to "Not more than 100 pins per area"
        // The library automatically aggregates points.
        const markers = L.markerClusterGroup({
            disableClusteringAtZoom: 16, // At zoom 16, show all individual pins
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            chunkedLoading: true // Performance boost for thousands of markers
        });
        
        map.addLayer(markers);

        // --- Fetch Logic ---
        async function loadProviders() {
            // 1. Show Loader
            loader.classList.add('active');

            // 2. Get Values from Inputs
            const city = document.getElementById('city').value;
            const specialty = document.getElementById('specialty').value;
            const network = document.getElementById('network').value;
            const name = document.getElementById('providerName').value;

            // 3. Build Query String for our Astro API Proxy
            const params = new URLSearchParams();
            if (city) params.append('city', city);
            if (specialty) params.append('specialty', specialty);
            if (network) params.append('network', network);
            if (name) params.append('name', name);

            try {
                // 4. Call our internal API (Step 2)
                const res = await fetch(`/api/get-providers?${params.toString()}`);
                const data = await res.json();

                // 5. Update Map
                updateMapMarkers(data);

            } catch (err) {
                console.error("Failed to load map data", err);
                alert("Could not load medical network data.");
            } finally {
                loader.classList.remove('active');
            }
        }

        // --- Map Update Logic ---
        function updateMapMarkers(providers) {
            // Clear existing
            markers.clearLayers();

            const newMarkers = [];

            providers.forEach(p => {
                // Create a marker
                const m = L.marker([p.lat, p.lng]);
                
                // Bind Popup
                m.bindPopup(`
                    <div style="font-family: sans-serif; min-width: 200px">
                        <h3 style="margin: 0 0 5px; color: #2563eb; font-size: 16px;">${p.name}</h3>
                        <div style="font-size: 13px; color: #555;">
                            <strong>City:</strong> ${p.city}<br/>
                            <strong>Spec:</strong> ${p.specialty}<br/>
                            <strong>Network:</strong> <span style="background:#eee; padding:2px 4px; border-radius:3px">${p.network || 'N/A'}</span>
                        </div>
                    </div>
                `);

                newMarkers.push(m);
            });

            // Add all to Cluster Group
            markers.addLayers(newMarkers);

            // Update Count Text
            countDisplay.innerText = `Found ${providers.length} providers`;

            // Fit map to bounds of results
            if (newMarkers.length > 0) {
                map.fitBounds(markers.getBounds(), { padding: [50, 50] });
            }
        }

        // --- Event Listeners ---
        document.getElementById('filter-form').addEventListener('submit', (e) => {
            e.preventDefault();
            loadProviders();
        });

        // Initial Load (Optional: load all providers on start)
        loadProviders();

    </script>
</body>
</html>